---
title: "Countering AntiVaccination Attitudes Replication"
author: "Derek Powell & Kara Weisman"
output: 
  html_notebook: 
    code_folding: hide
---

__NOTE: These are preliminary analyses as of 3/26/18, 8:59 AM__

This is an R notebook to analyze the data from the Countering AntiVaccination Attitudes (CAVA) replication study.

This replication roject was preregistered: https://osf.io/j5n4e/

- Part 1 of the study was conducted on March 21, 2018
- Part 2 of the study was conducted on March 22, 2018 (with a few Ps collected March 23, 2018)

```{r}
# load packages
library(tidyverse)
library(brms)
if (!require(betareg)) {
  install.packages("betareg")
}
library(betareg)

# Define some functions ...
read_qualtrics_csv <- function(fname) {
  df <- read.csv(fname, skip = 3, header = F)
  headers <- as.matrix(read.csv(fname, skip = 0, header = F, nrows = 1, as.is = T))
  colnames(df) <- headers
  df <- df[which(df[, "DistributionChannel", ] == "anonymous"), ] # remove survey previews
  total_n <- nrow(df)

  # remove unused qualtrics variables
  remove_cols <- c(
    "RecipientLastdata",
    "RecipientFirstdata",
    "RecipientEmail",
    "Finished",
    "ResponseId",
    "ExternalReference",
    "DistributionChannel",
    "UserLanguage",
    "Status"
  )

  df <- df[, -which(colnames(df) %in% remove_cols)]

  return(df)
}

rescale_beta <- function(x, lower, upper) {
  # rescales onto the open interval (0,1)
  # rescales over theoretical bounds of measurement, specified by "upper" and "lower"
  # based on Smithson & Verkuilen (2006), though this is not as principled as you might think
  # see http://dx.doi.org/10.1037/1082-989X.11.1.54.supp

  N <- length(x)
  res <- (x - lower) / (upper - lower)
  res <- (res * (N - 1) + .5) / N

  return(as.vector(res))
}
```

```{r}
# working from raw qualtrics with workerIds anonymized

# Data preprocessing ...
d_pre <- read_qualtrics_csv("data/Vaccine+PNAS+replication+day1-2018-03-23.csv") %>%
  select(workerId, age:Vax1_Vax1_36, eligible, study_time, payment)

d_post <- read_qualtrics_csv("data/Vaccine+PNAS+replication+day2-2018-03-23.csv") %>%
  select(workerId, condition, vax2_Vax1_1:vax2_Vax1_36, parent:SC1)

d_merge <- merge(d_pre,d_post, by="workerId") %>%
  as_tibble() %>%
  filter(SC1==4) %>%
  filter(Attention==1)

# rename variables and do reverse coding

d_untidy <- d_merge %>%
  select(-Vax1_Vax1_check,-vax2_Vax1_check) %>%
  rename(
    vax_pre_risks = Vax1_Vax1_1,
    vax_pre_herd = Vax1_Vax1_2,
    vax_pre_plan = Vax1_Vax1_3,
    vax_pre_uncommon = Vax1_Vax1_4,
    vax_pre_doctors = Vax1_Vax1_5,
    vax_pre_autism = Vax1_Vax1_6,
    vaxIntent_pre_Iwould = Vax1_Vax1_33,
    vaxIntent_pre_spreadOut = Vax1_Vax1_34,
    vaxIntent_pre_confident = Vax1_Vax1_35,
    vaxIntent_pre_wouldNever = Vax1_Vax1_36,
    vax_post_risks = vax2_Vax1_1,
    vax_post_herd = vax2_Vax1_2,
    vax_post_plan = vax2_Vax1_3,
    vax_post_uncommon = vax2_Vax1_4,
    vax_post_doctors = vax2_Vax1_5,
    vax_post_autism = vax2_Vax1_6,
    vaxIntent_post_Iwould = vax2_Vax1_33,
    vaxIntent_post_spreadOut = vax2_Vax1_34,
    vaxIntent_post_confident = vax2_Vax1_35,
    vaxIntent_post_wouldNever = vax2_Vax1_36
  ) %>%
  mutate( # implement reverse coding
    vax_pre_risks = 7 - vax_pre_risks,
    vax_post_risks = 7 - vax_post_risks,
    vax_pre_uncommon = 7 - vax_pre_uncommon,
    vax_post_uncommon = 7 - vax_post_uncommon,
    vaxIntent_pre_spreadOut = 7 - vaxIntent_pre_spreadOut,
    vaxIntent_post_spreadOut = 7 - vaxIntent_post_spreadOut,
    vaxIntent_pre_wouldNever = 7 - vaxIntent_pre_wouldNever,
    vaxIntent_post_wouldNever = 7 - vaxIntent_post_wouldNever
  ) %>% 
  mutate( # add duplicates to cover both scales
    vaxIntent_pre_risks = vax_pre_risks,
    vaxIntent_post_risks = vax_post_risks
  )
```

```{r}
# more munging to tidy data ...
d <- d_untidy %>%
  gather(item, rating, contains("vax")) %>%
  mutate(
    rating = as.integer(rating),
    phase = ifelse(grepl("_pre_",item),"pretest","posttest"),
    Scale = ifelse(grepl("vaxIntent_",item), "vaxIntent", "vaxAttitude"),
    condition = relevel(condition, ref="bird")
    ) %>%
  mutate(Scale = ifelse(grepl("autism",item), "autism", Scale)) %>%
  mutate(item=gsub("vax_pre_","", item)) %>%
  mutate(item=gsub("vax_post_","", item)) %>%
  mutate(item=gsub("vaxIntent_pre_","", item)) %>%
  mutate(item=gsub("vaxIntent_post_","", item))

# and reducing to a "summary" dataset
d_sum <- d %>%
  filter(Scale=="vaxAttitude") %>%
  group_by(workerId, condition, phase) %>%
  summarize(mean_rating = mean(rating)) %>%
  spread(phase, mean_rating) %>%
  mutate(change = posttest - pretest)
```

## Check scale reliability and confirm proper reverse coding

For vaccine attitudes ...

```{r}
d %>% filter(Scale=="vaxAttitude", phase=="pretest") %>% spread(item, rating) %>% select(doctors:uncommon) %>% psych::alpha()

d %>% filter(Scale=="vaxAttitude", phase=="posttest") %>% spread(item, rating) %>% select(doctors:uncommon) %>% psych::alpha()
```

for vaccine intentions ...

```{r}
d %>% filter(Scale=="vaxIntent", phase=="pretest") %>% spread(item, rating) %>% select(confident:wouldNever) %>% psych::alpha()

d %>% filter(Scale=="vaxIntent", phase=="posttest") %>% spread(item, rating) %>% select(confident:wouldNever) %>% psych::alpha()
```

## Comparing conditions at pretest

```{r}
d_sum %>%
  ggplot(aes(x=pretest, fill=condition)) +
  geom_density(alpha=.25) +
  theme_minimal()

# d_sum %>%
#   ggplot(aes(x=condition, y = pretest)) +
#   geom_violin()
```

```{r}
fit_pre <- betareg(rescale_beta(pretest,1,6) ~ condition, data=d_sum)
summary(fit_pre)
```

Participants in the autism correction and disease risk conditions had slightly (tho non-significantly) higher pretest scores than participants in the control condition. Presumably, this should have made it all the more difficult to improve attitudes in those conditions relative to control.

## Plotting Change Scores

Plotting to replicate figure 1 from _PNAS_ paper.

```{r}
# standard error function
stderr <- function(x) {
          sqrt(var(x[!is.na(x)]) / length(x[!is.na(x)]))
}

d %>%
  filter(Scale=="vaxAttitude") %>%
  group_by(workerId, condition, phase) %>%
  summarize(mean_rating = mean(rating)) %>%
  spread(phase, mean_rating) %>%
  summarize(change_score = posttest-pretest) %>%
  group_by(condition) %>%
  summarize(mean_change = mean(change_score),
            ul = mean(change_score) + stderr(change_score),
            ll = mean(change_score) - stderr(change_score)) %>%
  ggplot(aes(x=condition, fill=condition, y = mean_change, ymin=ll, ymax=ul)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=.25) +
  theme_minimal() +
  labs(title="Change Score Analysis")

```

Anaysis of change scores shows significant improvement in disease risk condition. This analysis replicates the original analyses and the primary pre-registered analysis. We directly replicate the original findings.

```{r}
fit_aov <- aov(change ~ condition, data = d_sum)
summary(fit_aov)

t.test(change ~ condition, data = d_sum %>% filter(condition!="autism"))
t.test(change ~ condition, data = d_sum %>% filter(condition!="bird"))

```

However, ANOVA on change scores is not the optimal approach to analyzing these data. In the following we explore some other approaches that should let us more accurately assess the true magnitude of the intervention's effect.

## Model: Posttest scores by condition, controlling for pretest

### Linear regression model

```{r}
fit_lm <- lm(posttest ~ scale(pretest) * condition,
           data=d_sum)

summary(fit_lm)
```

### Beta Regression

```{r}
fit_beta <- betareg(rescale_beta(posttest,1,6) ~ scale(pretest) + condition,
           data=d_sum)

summary(fit_beta)
```

and in BRMS ...

```{r}
# fit_brm_beta <- brm(
#   rescale_beta(posttest, 1, 6) ~ scale(pretest) + condition,
#   data = d_sum,
#   family = Beta(), # student(), #cumulative(), #bernoulli(), etc
#   control = list(adapt_delta = .85),
#   cores = parallel::detectCores(),
#   iter = 2000
# )
```

Plotting condition effects estimated from the model (50% credible intervals).

```{r}
# summary(fit_brm_beta)
# 
# me2 <- marginal_effects(fit_brm_beta, effects = "condition", probs = c(.25, .75))
# plt.me2 <- plot(me2,
#   effects = "condition",
#   plot = FALSE,
#   rug = TRUE,
#   theme = ggplot2::theme_get()
# )[[1]] + 
#   labs(title = "Beta Regression: Marginal Effects") + 
#   theme_minimal()
# 
# plt.me2
```

## Hierarchical ordinal regression

This is likely the __MOST__ appropriate analysis, accounting for the ordinal nature of the underlying response variable, as well as possible differences among scale items.

```{r}
# fit_brm_cum_posttest <- brm(
#   posttest ~ pretest + condition + (1 | workerId) + (1 | item),
#   data = d %>% filter(Scale=="vaxAttitude") %>% spread(phase, rating),
#   family = cumulative(), # student(), #cumulative(), #bernoulli(), etc
#   control = list(adapt_delta = .85),
#   cores = parallel::detectCores(),
#   iter = 2000
# )
```

```{r}
# summary(fit_brm_cum_posttest)
```

# "Vaccine intent" scale results

Here's a plot of the change scores for the vaccine intent scale across conditions. There don't appear to be any differences. (and note change in y-axis scale compared to previous plots)

```{r}
d %>%
  filter(Scale=="vaxIntent") %>%
  group_by(workerId, condition, phase) %>%
  summarize(mean_rating = mean(rating)) %>%
  spread(phase, mean_rating) %>%
  summarize(change_score = posttest-pretest) %>%
  group_by(condition) %>%
  summarize(mean_change = mean(change_score),
            ul = mean(change_score) + stderr(change_score),
            ll = mean(change_score) - stderr(change_score)) %>%
  ggplot(aes(x=condition, fill=condition, y = mean_change, ymin=ll, ymax=ul)) +
  geom_bar(stat="identity") +
  geom_errorbar(width=.25) +
  theme_minimal() +
  labs(title="Change Score Analysis: Vaccine Intent")
```

## Linear regression

Nothing much going on here.

```{r}
d_sum_intent <- d %>%
  filter(Scale == "vaxIntent") %>%
  group_by(workerId, condition, phase) %>%
  summarize(mean_rating = mean(rating)) %>%
  spread(phase, mean_rating)

fit_lm_intent <- lm(posttest ~ scale(pretest) * condition, data = d_sum_intent)
summary(fit_lm_intent)
```

## Beta regression

Nor here.

```{r}
d_sum_intent <- d %>%
  filter(Scale == "vaxIntent") %>%
  group_by(workerId, condition, phase) %>%
  summarize(mean_rating = mean(rating)) %>%
  spread(phase, mean_rating)

fit_beta_intent <- betareg(
  rescale_beta(posttest, 1, 6) ~ scale(pretest) + condition,
  data = d_sum_intent
)

summary(fit_beta_intent)
```

## Ordinal HLM

Nor, finally, here.

```{r}
# fit_brm_cum_posttest_intent <- brm(
#   posttest ~ pretest + condition + (1 | workerId) + (1 | item),
#   data = d %>% filter(Scale=="vaxIntent") %>% spread(phase, rating),
#   family = cumulative(), # student(), #cumulative(), #bernoulli(), etc
#   control = list(adapt_delta = .85),
#   cores = parallel::detectCores(),
#   iter = 2000
# )
```

```{r}
# summary(fit_brm_cum_posttest_intent)
```

# Summary

This study successfully replicated the original findings of the _PNAS_ paper according to both its "direct replication" criterion and the "best model" criterion. The "disease risk" manipulation significantly improved attitudes toward vaccines as measured by the 5-item "vaccine attitudes" scale. However, despite generally improving attitudes, the intervention did not increase participants' reported intentions to vaccinate their children, as measured by our new 5-item "vaccine intentions" scale. Further analyses are needed to begin exploring the reasons for this.

# Replication notes

Analyses can be replicated using `derekpowell/rstudio-dmp:20180321` Docker image.

### `sessionInfo()`

```{r}
sessionInfo()
```

